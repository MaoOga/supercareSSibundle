<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supercare Hospital - Reset Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <style>
      :root {
        --bg-body: #f3f4f6;
        --bg-card: #ffffff;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --button-bg: rgb(26, 175, 81);
        --button-bg-hover: rgb(22, 163, 74);
        --border-secondary: #e5e7eb;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-primary);
      }

      .reset-card {
        background: var(--bg-card);
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .gradient-bg {
        background: linear-gradient(
          135deg,
          rgb(26, 175, 81) 0%,
          rgb(22, 163, 74) 100%
        );
      }

      .password-requirements {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.5rem;
      }

      .password-container {
        position: relative;
      }

      .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .password-toggle:hover {
        color: rgb(26, 175, 81);
        background-color: rgba(26, 175, 81, 0.1);
      }

      .password-toggle:focus {
        outline: none;
        color: rgb(26, 175, 81);
        background-color: rgba(26, 175, 81, 0.1);
      }

      .password-input {
        padding-right: 40px;
      }

      .requirement {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
      }

      .requirement i {
        margin-right: 0.5rem;
        width: 16px;
      }

      .requirement.met {
        color: #059669;
      }

      .requirement.not-met {
        color: #dc2626;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <!-- Logo and Title -->
      <div class="text-center mb-8">
        <img
          src="../assets/supercare-hospital_logo.png"
          alt="Supercare Hospital"
          class="h-20 w-20 mx-auto mb-4"
        />
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Reset Password</h1>
        <p class="text-gray-600">Enter your new password</p>
      </div>

      <!-- Reset Password Form -->
      <div class="reset-card p-8">
        <form id="resetPasswordForm" class="space-y-6">
          <div>
            <label
              for="newPassword"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              New Password
            </label>
            <div class="password-container">
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                required
                class="password-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                placeholder="Enter your new password"
              />
              <button
                type="button"
                id="toggleNewPassword"
                class="password-toggle"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye" id="newPasswordIcon"></i>
              </button>
            </div>
            <div class="password-requirements">
              <div class="requirement" id="length-req">
                <i class="fas fa-circle"></i>
                At least 8 characters
              </div>
              <div class="requirement" id="uppercase-req">
                <i class="fas fa-circle"></i>
                One uppercase letter
              </div>
              <div class="requirement" id="lowercase-req">
                <i class="fas fa-circle"></i>
                One lowercase letter
              </div>
              <div class="requirement" id="number-req">
                <i class="fas fa-circle"></i>
                One number
              </div>
            </div>
          </div>

          <div>
            <label
              for="confirmPassword"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Confirm Password
            </label>
            <div class="password-container">
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                class="password-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                placeholder="Confirm your new password"
              />
              <button
                type="button"
                id="toggleConfirmPassword"
                class="password-toggle"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye" id="confirmPasswordIcon"></i>
              </button>
            </div>
          </div>

          <div id="messageDiv" class="hidden text-center">
            <span id="messageText"></span>
          </div>

          <button
            type="submit"
            id="submitBtn"
            class="w-full gradient-bg text-white py-2 px-4 rounded-md hover:opacity-90 transition-opacity duration-200 font-medium"
          >
            <i class="fas fa-key mr-2"></i>
            Reset Password
          </button>

          <div class="text-center">
            <a
              href="login.html"
              id="backToLoginLink"
              class="text-sm text-gray-600 hover:text-gray-800 hover:underline"
            >
              <i class="fas fa-arrow-left mr-1"></i>
              Back to Login
            </a>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Password toggle functionality for new password
      const toggleNewPassword = document.getElementById("toggleNewPassword");
      const newPasswordInput = document.getElementById("newPassword");
      const newPasswordIcon = document.getElementById("newPasswordIcon");

      toggleNewPassword.addEventListener("click", function () {
        const type =
          newPasswordInput.getAttribute("type") === "password"
            ? "text"
            : "password";
        newPasswordInput.setAttribute("type", type);

        // Update icon
        if (type === "text") {
          newPasswordIcon.classList.remove("fa-eye");
          newPasswordIcon.classList.add("fa-eye-slash");
          toggleNewPassword.setAttribute("aria-label", "Hide password");
        } else {
          newPasswordIcon.classList.remove("fa-eye-slash");
          newPasswordIcon.classList.add("fa-eye");
          toggleNewPassword.setAttribute("aria-label", "Show password");
        }
      });

      // Password toggle functionality for confirm password
      const toggleConfirmPassword = document.getElementById(
        "toggleConfirmPassword"
      );
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const confirmPasswordIcon = document.getElementById(
        "confirmPasswordIcon"
      );

      toggleConfirmPassword.addEventListener("click", function () {
        const type =
          confirmPasswordInput.getAttribute("type") === "password"
            ? "text"
            : "password";
        confirmPasswordInput.setAttribute("type", type);

        // Update icon
        if (type === "text") {
          confirmPasswordIcon.classList.remove("fa-eye");
          confirmPasswordIcon.classList.add("fa-eye-slash");
          toggleConfirmPassword.setAttribute("aria-label", "Hide password");
        } else {
          confirmPasswordIcon.classList.remove("fa-eye-slash");
          confirmPasswordIcon.classList.add("fa-eye");
          toggleConfirmPassword.setAttribute("aria-label", "Show password");
        }
      });

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");

      // Check if token exists
      if (!token) {
        showMessage(
          "Invalid or missing reset token. Please request a new password reset link.",
          false,
          false
        );
        document.getElementById("submitBtn").disabled = true;
      } else {
        // Fetch token info to set correct back to login link
        const formData = new FormData();
        formData.append("token", token);

        fetch("get_token_info.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const formAccess = data.form_access || "ssi";
              const backToLoginLink =
                document.getElementById("backToLoginLink");

              if (formAccess === "cauti") {
                backToLoginLink.href = "../Cauti_form/cauti_login.html";
              } else {
                backToLoginLink.href = "login.html";
              }
            }
          })
          .catch((error) => {
            console.error("Error fetching token info:", error);
            // Default to SSI login if error
            document.getElementById("backToLoginLink").href = "login.html";
          });
      }

      // Function to show message
      function showMessage(message, isSuccess = false, autoHide = false) {
        const messageDiv = document.getElementById("messageDiv");
        const messageText = document.getElementById("messageText");

        messageText.textContent = message;
        messageDiv.classList.remove("hidden");

        // Set color based on success/error
        if (isSuccess) {
          messageDiv.className = "text-green-600 text-center";
        } else {
          messageDiv.className = "text-red-600 text-center";
        }

        if (autoHide) {
          setTimeout(() => {
            messageDiv.classList.add("hidden");
          }, 5000);
        }
      }

      // Function to hide message
      function hideMessage() {
        document.getElementById("messageDiv").classList.add("hidden");
      }

      // Password validation
      function validatePassword(password) {
        const requirements = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /\d/.test(password),
        };

        // Update requirement indicators
        document.getElementById("length-req").className = `requirement ${
          requirements.length ? "met" : "not-met"
        }`;
        document.getElementById("length-req").innerHTML = `<i class="fas fa-${
          requirements.length ? "check" : "times"
        }"></i>At least 8 characters`;

        document.getElementById("uppercase-req").className = `requirement ${
          requirements.uppercase ? "met" : "not-met"
        }`;
        document.getElementById(
          "uppercase-req"
        ).innerHTML = `<i class="fas fa-${
          requirements.uppercase ? "check" : "times"
        }"></i>One uppercase letter`;

        document.getElementById("lowercase-req").className = `requirement ${
          requirements.lowercase ? "met" : "not-met"
        }`;
        document.getElementById(
          "lowercase-req"
        ).innerHTML = `<i class="fas fa-${
          requirements.lowercase ? "check" : "times"
        }"></i>One lowercase letter`;

        document.getElementById("number-req").className = `requirement ${
          requirements.number ? "met" : "not-met"
        }`;
        document.getElementById("number-req").innerHTML = `<i class="fas fa-${
          requirements.number ? "check" : "times"
        }"></i>One number`;

        return Object.values(requirements).every((req) => req);
      }

      // Check passwords match
      function checkPasswordsMatch() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        return newPassword === confirmPassword;
      }

      // Event listeners for password validation
      document
        .getElementById("newPassword")
        .addEventListener("input", function () {
          validatePassword(this.value);
        });

      document
        .getElementById("confirmPassword")
        .addEventListener("input", function () {
          const newPassword = document.getElementById("newPassword").value;
          if (newPassword && this.value) {
            if (newPassword !== this.value) {
              this.setCustomValidity("Passwords do not match");
            } else {
              this.setCustomValidity("");
            }
          }
        });

      document
        .getElementById("resetPasswordForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const submitBtn = document.getElementById("submitBtn");

          // Clear previous message
          hideMessage();

          // Validate password
          if (!validatePassword(newPassword)) {
            showMessage(
              "Please ensure your password meets all requirements.",
              false,
              true
            );
            return;
          }

          // Check if passwords match
          if (newPassword !== confirmPassword) {
            showMessage(
              "Passwords do not match. Please try again.",
              false,
              true
            );
            return;
          }

          // Show loading state
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting...';
          submitBtn.disabled = true;

          // Create form data
          const formData = new FormData();
          formData.append("token", token);
          formData.append("newPassword", newPassword);

          // Send reset password request
          fetch("reset_password.php", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showMessage(
                  "Password has been reset successfully! You can now login with your new password.",
                  true,
                  false
                );
                // Clear the form
                document.getElementById("newPassword").value = "";
                document.getElementById("confirmPassword").value = "";
                // Redirect to appropriate login page after 3 seconds
                const redirectUrl = data.redirect_url || "login.html";
                setTimeout(() => {
                  window.location.href = redirectUrl;
                }, 3000);
              } else {
                showMessage(
                  data.message || "Failed to reset password",
                  false,
                  true
                );
              }

              // Reset button
              submitBtn.innerHTML =
                '<i class="fas fa-key mr-2"></i>Reset Password';
              submitBtn.disabled = false;
            })
            .catch((error) => {
              console.error("Error:", error);
              showMessage(
                "Network error occurred. Please try again.",
                false,
                true
              );

              // Reset button
              submitBtn.innerHTML =
                '<i class="fas fa-key mr-2"></i>Reset Password';
              submitBtn.disabled = false;
            });
        });
    </script>
  </body>
</html>
