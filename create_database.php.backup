<?php
// Database setup script
echo "<h2>Database Setup</h2>";
echo "<pre>";

// Database configuration
$host = 'localhost';
$username = 'root';
$password = '';

try {
    // Connect to MySQL server (without database)
    echo "Step 1: Connecting to MySQL server...\n";
    $pdo = new PDO("mysql:host=$host", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "✅ Connected to MySQL server\n";
    
    // Create database if it doesn't exist
    echo "\nStep 2: Creating database 'supercare_ssi'...\n";
    $pdo->exec("CREATE DATABASE IF NOT EXISTS supercare_ssi CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
    echo "✅ Database 'supercare_ssi' created/verified\n";
    
    // Connect to the specific database
    echo "\nStep 3: Connecting to 'supercare_ssi' database...\n";
    $pdo = new PDO("mysql:host=$host;dbname=supercare_ssi;charset=utf8mb4", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "✅ Connected to 'supercare_ssi' database\n";
    
    // Create admin_users table
    echo "\nStep 4: Creating admin_users table...\n";
    $sql = "CREATE TABLE IF NOT EXISTS admin_users (
        id INT AUTO_INCREMENT PRIMARY KEY,
        admin_username VARCHAR(50) UNIQUE NOT NULL,
        name VARCHAR(100) NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        status ENUM('active', 'inactive') DEFAULT 'active',
        remember_token VARCHAR(100) NULL,
        last_login TIMESTAMP NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    )";
    $pdo->exec($sql);
    echo "✅ admin_users table created/verified\n";
    
    // Create admin_login_logs table
    echo "\nStep 5: Creating admin_login_logs table...\n";
    $sql = "CREATE TABLE IF NOT EXISTS admin_login_logs (
        id INT AUTO_INCREMENT PRIMARY KEY,
        email VARCHAR(100) NOT NULL,
        status ENUM('success', 'failed') NOT NULL,
        message TEXT,
        ip_address VARCHAR(45),
        user_agent TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )";
    $pdo->exec($sql);
    echo "✅ admin_login_logs table created/verified\n";
    
    // Check if admin user exists
    echo "\nStep 6: Checking for admin user...\n";
    $stmt = $pdo->query("SELECT COUNT(*) as count FROM admin_users");
    $result = $stmt->fetch();
    
    if ($result['count'] == 0) {
        echo "No admin users found. Creating default admin user...\n";
        
        // Create default admin user
        $defaultPassword = password_hash('admin123', PASSWORD_DEFAULT);
        $sql = "INSERT INTO admin_users (admin_username, name, email, password, status) 
                VALUES (?, ?, ?, ?, ?)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute(['admin', 'System Administrator', 'admin@supercare.com', $defaultPassword, 'active']);
        
        echo "✅ Default admin user created:\n";
        echo "  Username: admin\n";
        echo "  Email: admin@supercare.com\n";
        echo "  Password: admin123\n";
        echo "  ⚠️  Please change this password after first login!\n";
    } else {
        echo "✅ Admin users already exist\n";
    }
    
    // Show table structure
    echo "\nStep 7: Database structure summary:\n";
    $tables = ['admin_users', 'admin_login_logs'];
    foreach ($tables as $table) {
        echo "\nTable: $table\n";
        $stmt = $pdo->query("DESCRIBE $table");
        $columns = $stmt->fetchAll();
        foreach ($columns as $column) {
            echo "  - " . $column['Field'] . " (" . $column['Type'] . ")\n";
        }
    }
    
    echo "\n✅ Database setup completed successfully!\n";
    echo "\nYou can now:\n";
    echo "1. <a href='admin_login_simple.html'>Go to Admin Login</a>\n";
    echo "2. Use the default credentials:\n";
    echo "   - Email: admin@supercare.com\n";
    echo "   - Password: admin123\n";
    
} catch (PDOException $e) {
    echo "❌ Database setup failed: " . $e->getMessage() . "\n";
    echo "\nPlease make sure:\n";
    echo "1. XAMPP is running\n";
    echo "2. MySQL service is started\n";
    echo "3. You have proper permissions\n";
}

echo "</pre>";
?>
