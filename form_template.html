<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surgical Monitoring Form</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <style>
      /* Mobile header consistency for form page */
      @media (max-width: 640px) {
        .header {
          padding: 0.75rem !important;
        }
        .header img {
          height: 56px !important;
          width: 56px !important;
        }
        .title-main {
          font-size: 1.125rem !important;
          line-height: 1.5 !important;
        }
        .title-sub {
          font-size: 0.875rem !important;
        }
      }

      /* Center form and mobile fit */
      @media (max-width: 768px) {
        .container {
          max-width: 100% !important;
          margin: 0 auto !important;
          padding: 0 10px !important;
          box-sizing: border-box !important;
        }

        .tg {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 auto !important;
        }

        /* Ensure tables don't overflow */
        .cultural-swap-table-wrapper,
        .wound-complications-table-wrapper,
        .post-operative-table-wrapper,
        .antibiotic-table-wrapper {
          overflow-x: auto !important;
          max-width: 100% !important;
        }

        /* Center the form content */
        #ssiForm {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 auto !important;
        }

        /* Center all form elements */
        .header {
          text-align: center !important;
          margin: 0 auto !important;
        }

        /* Ensure proper centering for all tables */
        table.tg {
          margin: 0 auto !important;
          display: table !important;
        }

        /* Center action buttons */
        .mt-4.text-right {
          text-align: center !important;
        }

        /* Center submit button container */
        div[style*="text-align: center"] {
          text-align: center !important;
          width: 100% !important;
        }
      }

      /* Extra small devices - ensure full width and centering */
      @media (max-width: 480px) {
        .container {
          padding: 0 5px !important;
          margin: 0 auto !important;
        }

        .tg {
          width: 100% !important;
          margin: 0 auto !important;
        }

        /* Ensure all content is centered */
        body {
          text-align: center !important;
        }

        /* Reset text alignment for form content */
        .tg th,
        .tg td,
        .label-bold,
        input,
        textarea,
        select {
          text-align: left !important;
        }
      }

      /* Mobile signature layout */
      @media (max-width: 768px) {
        /* Date completed and signature container */
        div[style*="display: flex"][style*="justify-content: space-between"] {
          flex-direction: column !important;
          gap: 15px !important;
        }

        /* Date completed field */
        div[style*="display: flex"][style*="justify-content: space-between"]
          label:first-child {
          width: 100% !important;
          margin-bottom: 10px !important;
        }

        /* Signature field */
        div[style*="display: flex"][style*="justify-content: space-between"]
          label:last-child {
          width: 100% !important;
          margin-top: 10px !important;
        }

        /* Signature input styling */
        input[name="signature"] {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="messageBox" style="display: none"></div>
      <form id="ssiForm" method="post">
        <input type="hidden" name="patient_id" id="patient_id" value="" />
        <div class="header">
          <img src="supercare-hospital_logo.png" alt="Supercare Logo" />
          <div class="title-main">SSI BUNDLE CHECKLIST</div>
          <div class="title-sub">Supercare</div>
        </div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full"
                  >Name:
                  <textarea
                    name="name"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </th>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full"
                  >Age:
                  <input
                    type="number"
                    class="input-overlay"
                    name="age"
                    style="font-size: 13px"
                  />
                </label>
              </th>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full"
                  >Sex:
                  <select
                    name="Sex"
                    class="surgeon-select"
                    style="
                      width: 80%;
                      margin-left: 8px;
                      font-size: 13px;
                      font-weight: bold;
                      border: none;
                      height: 30px;
                      vertical-align: middle;
                    "
                    required
                  >
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                  </select>
                </label>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full"
                  >UHID:
                  <input type="text" class="input-overlay" name="uhid" />
                </label>
                <div
                  id="uhidFeedback"
                  style="
                    display: none;
                    font-size: 12px;
                    margin-top: 2px;
                    font-weight: bold;
                  "
                ></div>
              </td>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Phone No: </span>
                  <input
                    type="tel"
                    class="input-overlay"
                    name="phone"
                    style="font-size: 13px"
                  />
                </label>
              </td>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full"
                  >Bed no./Ward:
                  <input type="text" class="input-overlay" name="bed" />
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="3">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Address: </span>
                  <textarea
                    class="input-overlay input-full"
                    name="address"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="3">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >Primary Diagnosis:</span
                  >
                  <textarea
                    class="input-overlay input-full"
                    name="diagnosis"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="3">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >Surgical Procedure:</span
                  >
                  <textarea
                    name="surgical_procedure"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="section-break"></div>
        <table class="tg tg-doa-dos-dod-surgeon">
          <thead>
            <tr>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center"
                  >DOA:
                  <input
                    type="text"
                    name="patient_info[doa]"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px"
                    value=""
                  />
                </label>
              </th>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center"
                  >DOS:
                  <input
                    type="text"
                    name="patient_info[dos]"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px"
                    value=""
                  />
                </label>
              </th>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center"
                  >DOD:
                  <input
                    type="text"
                    name="patient_info[dod]"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px"
                    value=""
                  />
                </label>
              </th>
              <th class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center"
                  >Surgeon:
                  <select
                    name="patient_info[surgeon]"
                    class="surgeon-select"
                    id="surgeonDropdown"
                    style="
                      width: 80%;
                      margin-left: 8px;
                      font-size: 13px;
                      font-weight: bold;
                      border: none;
                      height: 30px;
                      vertical-align: middle;
                    "
                    required
                  >
                    <option value="">Loading surgeons...</option>
                  </select>
                  <span
                    class="surgeon-print"
                    style="display: none; margin-left: 8px"
                  ></span>
                </label>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >Duration Of Operation:
                  </span>
                  <textarea
                    name="operation_duration"
                    class="input-overlay input-full"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.3; font-size: 13px"
                  ></textarea>
                </label>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="section-break"></div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="4">RISK FACTOR</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">a) Weight:</span>
                  <textarea
                    name="risk_factor_weight"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">b) Height:</span>
                  <textarea
                    name="risk_factor_height"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">c) Steroids:</span>
                  <textarea
                    name="risk_factor_steroids"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >d) Tuberculosis:</span
                  >
                  <textarea
                    name="risk_factor_tuberculosis"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">e) Others:</span>
                  <textarea
                    name="risk_factor_others"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="section-break"></div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="4">
                Surgical Skin Preparation Monitoring
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-67s2">Pre op Bath/Shower</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[pre_op_bath]"
                  value="Yes"
                />
                Yes
              </td>
              <td class="tg-0lax" colspan="2">
                <input
                  type="radio"
                  name="surgical_skin_preparation[pre_op_bath]"
                  value="No"
                />
                No
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >If not done (Reason):
                  </span>
                  <textarea
                    class="input-overlay input-full"
                    name="pre-notdone"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-67s2">Hair Removal</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[hair-removal]"
                  value="Razor"
                />
                Razor
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[hair-removal]"
                  value="Trimmer"
                />
                Trimmer
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[hair-removal]"
                  value="Not Done"
                />
                Not Done
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >If not done (Reason):</span
                  >
                  <textarea
                    class="input-overlay input-full"
                    name="hair-notdone"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-67s2">Where was hair removal done?</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[removal-done]"
                  value="Ward"
                />
                Ward
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[removal-done]"
                  value="ICU/HDU"
                />
                ICU/HDU
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="surgical_skin_preparation[removal-done]"
                  value="OT/LR"
                />
                OT/LR
              </td>
            </tr>
          </tbody>
        </table>
        <div class="page-break"></div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="4">Implanted Material</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-67s2">Implanted Used:</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="implanted_used"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax" colspan="2">
                <input
                  type="radio"
                  name="implanted_used"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Metal: </span>
                  <textarea
                    name="metal"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Graft: </span>
                  <textarea
                    name="graft"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Patch: </span>
                  <textarea
                    name="Patch"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
              <td class="tg-1wig" style="vertical-align: middle">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold"
                    >Shunt/Stent:
                  </span>
                  <textarea
                    name="Shunt"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr>
              <td class="tg-67s2">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Drain Used: </span>
                </label>
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="drain-used"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax" colspan="2">
                <input
                  type="radio"
                  name="drain-used"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
            <tr class="drain-row">
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">1. </span>
                  <textarea
                    name="drain_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr class="drain-row">
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">2. </span>
                  <textarea
                    name="drain_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
            <tr class="drain-row">
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">3. </span>
                  <textarea
                    name="drain_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="mt-4 text-right">
          <button type="button" onclick="addDrainRow()" class="action-button">
            +
          </button>
          <button
            type="button"
            onclick="removeDrainRow()"
            class="action-button"
          >
            −
          </button>
        </div>
        <div class="section-break"></div>
        <div class="antibiotic-table-wrapper">
          <table class="tg" id="antibiotic-table">
            <thead>
              <tr>
                <th class="tg-ty4g" colspan="5">Antibiotic Usage</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="tg-k2l0">Serial No.</td>
                <td class="tg-k2l0">Name Of The Drug</td>
                <td class="tg-k2l0">Dosage/Route/Frequency</td>
                <td class="tg-k2l0">Started On</td>
                <td class="tg-k2l0">Stopped On</td>
              </tr>
              <tr class="antibiotic-row">
                <td class="tg-k2l0">1</td>
                <td class="tg-1wig">
                  <textarea
                    name="drug-name_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </td>
                <td class="tg-1wig">
                  <textarea
                    name="dosage_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </td>
                <td class="tg-1wig">
                  <input
                    type="text"
                    name="antibiotic_usage[startedon]_1"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px"
                    value=""
                  />
                </td>
                <td class="tg-1wig">
                  <input
                    type="text"
                    name="antibiotic_usage[stoppeon]_1"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px"
                    value=""
                  />
                </td>
              </tr>
              <tr class="antibiotic-row">
                <td class="tg-k2l0">2</td>
                <td class="tg-1wig">
                  <textarea
                    name="drug-name_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </td>
                <td class="tg-1wig">
                  <textarea
                    name="dosage_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </td>
                <td class="tg-1wig">
                  <input
                    type="text"
                    name="antibiotic_usage[startedon]_2"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px"
                    value=""
                  />
                </td>
                <td class="tg-1wig">
                  <input
                    type="text"
                    name="antibiotic_usage[stoppeon]_2"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px"
                    value=""
                  />
                </td>
              </tr>
              <tr class="antibiotic-row">
                <td class="tg-k2l0">3</td>
                <td class="tg-1wig">
                  <textarea
                    name="drug-name_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </td>
                <td class="tg-1wig">
                  <textarea
                    name="dosage_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="min-height: 28px; line-height: 1.2"
                  ></textarea>
                </td>
                <td class="tg-1wig">
                  <input
                    type="text"
                    name="antibiotic_usage[startedon]_3"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px"
                    value=""
                  />
                </td>
                <td class="tg-1wig">
                  <input
                    type="text"
                    name="antibiotic_usage[stoppeon]_3"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px"
                    value=""
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="mt-4 text-right">
          <button
            type="button"
            onclick="addAntibioticRow()"
            class="action-button"
          >
            +
          </button>
          <button
            type="button"
            onclick="removeAntibioticRow()"
            class="action-button"
          >
            −
          </button>
        </div>
        <div class="page-break"></div>
        <h3
          class="post-operative"
          style="
            text-align: center;
            text-decoration: underline;
            font-weight: bold;
          "
        >
          Post-Operative Wound Monitoring
        </h3>
        <div class="post-operative-table-wrapper">
          <table class="tg" id="post-operative-table">
            <thead>
              <tr>
                <th class="tg-ty4g">Day<br /></th>
                <th class="tg-ty4g">Date<br /></th>
                <th class="tg-ty4g">Dosage</th>
                <th class="tg-ty4g">Type of <br />Discharge/Fluid</th>
                <th class="tg-ty4g">Tenderness/<br />Pain</th>
                <th class="tg-ty4g">Swelling</th>
                <th class="tg-ty4g">Fever</th>
              </tr>
            </thead>
            <tbody>
              <tr class="post-operative-row">
                <td class="tg-k2l0">1</td>
                <td class="tg-0lax">
                  <input
                    type="text"
                    name="post-operative[date]_1"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px; font-weight: bold"
                    value=""
                  />
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="post-dosage_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="type-ofdischarge_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="tenderness-pain_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="swelling_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="Fever_1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
              </tr>
              <tr class="post-operative-row">
                <td class="tg-k2l0">2</td>
                <td class="tg-0lax">
                  <input
                    type="text"
                    name="post-operative[date]_2"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px; font-weight: bold"
                    value=""
                  />
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="post-dosage_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="type-ofdischarge_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="tenderness-pain_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="swelling_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="Fever_2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
              </tr>
              <tr class="post-operative-row">
                <td class="tg-k2l0">3</td>
                <td class="tg-0lax">
                  <input
                    type="text"
                    name="post-operative[date]_3"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px; font-weight: bold"
                    value=""
                  />
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="post-dosage_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="type-ofdischarge_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="tenderness-pain_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="swelling_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
                <td class="tg-0lax">
                  <textarea
                    name="Fever_3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      text-align: center;
                      font-size: 13px;
                      font-weight: bold;
                    "
                  ></textarea>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="mt-4 text-right">
          <button
            type="button"
            onclick="addPostOperativeRow()"
            class="action-button"
          >
            +
          </button>
          <button
            type="button"
            onclick="removePostOperativeRow()"
            class="action-button"
          >
            −
          </button>
        </div>
        <div class="section-break"></div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="4">Cultural Swap</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <textarea
                  name="Cultural-Swap"
                  class="input-overlay input-full"
                  rows="3"
                  oninput="autoGrow(this)"
                  style="min-height: 84px; line-height: 1.2"
                ></textarea>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="section-break"></div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="4">Dressing/Finding</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <textarea
                  name="Dressing-Finding"
                  class="input-overlay input-full"
                  rows="3"
                  oninput="autoGrow(this)"
                  style="min-height: 84px; line-height: 1.2"
                ></textarea>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="page-break"></div>
        <div class="wound-complications-table-wrapper">
          <h3
            class="Wound-Complications"
            style="
              text-align: center;
              text-decoration: underline;
              font-weight: bold;
            "
          >
            Wound Complications
          </h3>
          <table class="tg tg-wound-complications">
            <tbody>
              <tr>
                <td class="tg-fymr" rowspan="6">
                  Wound Complications<br />SSI--> Tick Criteria--><br />Date:<input
                    type="text"
                    name="Wound-Complication_Date"
                    class="datepicker"
                    placeholder="dd/mm/yyyy"
                    style="width: 100px; font-size: 13px; font-weight: bold"
                    value=""
                  /><br /><br />OR<br /><br />Non-Infectious&nbsp;Complications<br /><br />Wound
                  Dehiscence
                  <input
                    type="checkbox"
                    name="wounddehiscene"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  /><br /><br />Allergic Reaction To Dressing
                  <input
                    type="checkbox"
                    name="AllergicR"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  /><br /><br />Bleeding/ Haemorrhage<input
                    type="checkbox"
                    name="BleedingH"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  /><br /><br />Other
                  <input
                    type="checkbox"
                    name="Other"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  /><br /><br />Specify:<br /><textarea
                    name="WoundD-Specify"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      font-size: 13px;
                      font-weight: normal;
                    "
                  ></textarea
                  ><br /><br /><br /><br /><br /><br /><br />Notes:<br /><textarea
                    name="WoundD-Notes"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      font-size: 13px;
                      font-weight: normal;
                    "
                  ></textarea
                  ><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
                </td>
                <td class="tg-7btt">
                  <input
                    type="checkbox"
                    name="SuperficialSSI"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                  Superficial SSI<br />(Skin/Sub-Cutaneoous)
                </td>
                <td class="tg-7btt">
                  <input
                    type="checkbox"
                    name="DeepSI"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                  Deep SI<br />(Fascia/Muscle)
                </td>
                <td class="tg-7btt">
                  <input
                    type="checkbox"
                    name="OrganSI"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                  Organ/Space SSI
                </td>
              </tr>
              <tr>
                <td class="tg-c3ow">
                  <br />Presence of purulent discharge from the surgical site
                  <input
                    type="checkbox"
                    name="wtd1-1"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  <br /><br /><br />Purulent discharge from the surgical site
                  <input
                    type="checkbox"
                    name="wtd1-2"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  Purulent discharge from a drain placed in the organ, space, or
                  cavity
                  <input
                    type="checkbox"
                    name="wtd1-3"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
              </tr>
              <tr>
                <td class="tg-c3ow">
                  Identification of an organism from the surgical site
                  <input
                    type="checkbox"
                    name="wtd2-1"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  Identification of an organism from the surgical site
                  <input
                    type="checkbox"
                    name="wtd2-1b"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  Identification of an isolated organism from the involved
                  organ, cavity, or related abscess
                  <input
                    type="checkbox"
                    name="wtd2-2"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
              </tr>
              <tr>
                <td class="tg-c3ow">
                  <br /><br />Clinical diagnosis of a SSI <br />by the surgeon
                  <input
                    type="checkbox"
                    name="wtd3-1"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  Deliberate reopening of a deep incision by the surgeon for
                  suspected infection, or wound spontaneously dehisces, and a
                  positive wound culture and ≥1 infectious symptoms (e.g,
                  localized pain, or tenderness)
                  <input
                    type="checkbox"
                    name="wtd3-2"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  <br /><br />Evidence of abscess or infection involving the
                  organ, cavity, <br />or anatomic space, as observed on CT
                  <input
                    type="checkbox"
                    name="wtd3-3"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
              </tr>
              <tr>
                <td class="tg-c3ow">
                  Deliberate opening of the<br />wound by the surgeon, and
                  <br />≥1 infectious symptom<br />(e.g, swelling, erythema,<br />or<br />localized
                  pain or warmth)
                  <input
                    type="checkbox"
                    name="wtd4-1"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  <br />Evidence of abscess formation or <br />infection
                  involving deep tissues as observed on CT
                  <input
                    type="checkbox"
                    name="wtd4-2"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
                <td class="tg-c3ow">
                  A wound is not considered<br />infected if only a stitch
                  abscess,<br />localized cellulitis, or infected<br />superficial
                  stab puncture<br />is present
                  <input
                    type="checkbox"
                    name="wtd4-3"
                    value="Yes"
                    class="form-checkbox text-blue-600"
                  />
                </td>
              </tr>
              <tr>
                <td class="tg-fymr">
                  Surgeon's Opinion:<br /><textarea
                    name="SurgeonOpinion1"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      font-size: 13px;
                      font-weight: normal;
                    "
                  ></textarea
                  ><br /><br /><br /><br />
                </td>
                <td class="tg-fymr">
                  Surgeon's Opinion:<br /><textarea
                    name="SurgeonOpinion2"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      font-size: 13px;
                      font-weight: normal;
                    "
                  ></textarea>
                </td>
                <td class="tg-fymr">
                  Surgeon's Opinion:<br /><textarea
                    name="SurgeonOpinion3"
                    class="input-overlay input-full"
                    rows="1"
                    oninput="autoGrow(this)"
                    style="
                      min-height: 28px;
                      line-height: 1.2;
                      font-size: 13px;
                      font-weight: normal;
                    "
                  ></textarea>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="section-break"></div>
        <table class="tg tg-review-sutures">
          <thead>
            <tr>
              <th class="tg-1wig">Review On</th>
              <th class="tg-0lax">
                <input
                  type="text"
                  name="ReviewOn"
                  class="datepicker"
                  placeholder="dd/mm/yyyy"
                  style="width: 100px; font-size: 13px; font-weight: bold"
                  value=""
                />
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig">Sutures/Clips Removed On</td>
              <td class="tg-0lax">
                <input
                  type="text"
                  name="SuturesROn"
                  class="datepicker"
                  placeholder="dd/mm/yyyy"
                  style="width: 100px; font-size: 13px; font-weight: bold"
                  value=""
                />
              </td>
            </tr>
          </tbody>
        </table>
        <div class="section-break"></div>
        <table class="tg">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="4">
                Infection Prevention Control Nurse Notes
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-1wig" style="vertical-align: middle" colspan="4">
                <label class="flex gap-2 items-center w-full">
                  <span class="whitespace-nowrap label-bold">Notes:</span>
                  <textarea
                    name="infection_prevention_notes"
                    class="input-overlay input-full"
                    rows="3"
                    oninput="autoGrow(this)"
                    style="min-height: 84px; line-height: 1.2"
                  ></textarea>
                </label>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="page-break"></div>
        <table class="tg tg-review-phone">
          <thead>
            <tr>
              <th class="tg-ty4g" colspan="3">Review or Phone Call</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="tg-k2l0" colspan="3">
                Date:<input
                  type="text"
                  name="RevieworPhoneDate"
                  class="datepicker"
                  placeholder="dd/mm/yyyy"
                  style="width: 100px; font-size: 13px; font-weight: bold"
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="tg-1wig">Patient Identification:</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewp"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewp"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
            <tr>
              <td class="tg-1wig">Pain:</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewppain"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewppain"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
            <tr>
              <td class="tg-1wig">Pus:</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewpus"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewpus"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
            <tr>
              <td class="tg-1wig">Bleeding:</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewbleed"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewbleed"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
            <tr>
              <td class="tg-1wig">Others</td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewother"
                  value="Yes"
                  class="form-radio text-blue-600"
                />
                Yes
              </td>
              <td class="tg-0lax">
                <input
                  type="radio"
                  name="reviewother"
                  value="No"
                  class="form-radio text-blue-600"
                />
                No
              </td>
            </tr>
          </tbody>
        </table>
        <div class="section-break"></div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
          "
        >
          <label class="flex gap-2 items-center"
            ><span class="label-bold">Date Completed:</span>
            <input
              type="text"
              name="date_completed"
              class="datepicker"
              placeholder="dd/mm/yyyy"
              style="width: 100px; font-size: 13px; font-weight: bold"
              value=""
            />
          </label>
          <label class="flex gap-2 items-center justify-end"
            ><span class="label-bold">Signature:</span>
            <input
              type="text"
              name="signature"
              class="input-overlay"
              style="
                width: 200px;
                font-size: 15px;
                font-weight: bold;
                border: 1px solid #000000;
                border-radius: 4px;
                padding: 4px 8px;
              "
            />
          </label>
        </div>

        <!-- Success Alert Container -->
        <div
          id="successAlert"
          style="display: none; text-align: center; margin: 1rem 0"
        >
          <div
            style="
              background-color: #d4edda;
              color: #155724;
              padding: 15px;
              border-radius: 8px;
              border: 1px solid #c3e6cb;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            "
          >
            <i
              class="fas fa-check-circle"
              style="margin-right: 8px; font-size: 18px"
            ></i>
            <span style="font-weight: bold; font-size: 16px"
              >Patient data saved successfully!</span
            >
            <p style="margin: 5px 0 0 0; font-size: 14px">
              Redirecting to dashboard...
            </p>
          </div>
        </div>

        <!-- Validation Alert Container -->
        <div
          id="validationAlert"
          style="display: none; text-align: center; margin: 1rem 0"
        >
          <div
            style="
              background-color: #f8d7da;
              color: #721c24;
              padding: 15px;
              border-radius: 8px;
              border: 1px solid #f5c6cb;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            "
          >
            <i
              class="fas fa-exclamation-triangle"
              style="margin-right: 8px; font-size: 18px"
            ></i>
            <span style="font-weight: bold; font-size: 16px"
              >Name and UHID are required fields.</span
            >
          </div>
        </div>

        <!-- Submit Button -->
        <div style="text-align: center; margin: 2rem 0">
          <button
            type="submit"
            style="
              background-color: #1aaf51;
              color: white;
              padding: 12px 30px;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            "
          >
            <i class="fas fa-save" style="margin-right: 8px"></i>
            Save Patient Data
          </button>
        </div>
      </form>
    </div>
    <script src="script.js" defer></script>

    <script>
      // Load surgeons from database
      function loadSurgeons() {
        const surgeonDropdown = document.getElementById("surgeonDropdown");
        if (!surgeonDropdown) return;

        fetch("get_surgeons.php")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Clear existing options except the first one
              surgeonDropdown.innerHTML =
                '<option value="">Select Surgeon</option>';

              // Add surgeons from database
              data.surgeons.forEach((surgeon) => {
                const option = document.createElement("option");
                option.value = surgeon.name;
                option.textContent = surgeon.name;
                surgeonDropdown.appendChild(option);
              });
            } else {
              surgeonDropdown.innerHTML =
                '<option value="">Error loading surgeons</option>';
              console.error("Error loading surgeons:", data.message);
            }
          })
          .catch((error) => {
            surgeonDropdown.innerHTML =
              '<option value="">Error loading surgeons</option>';
            console.error("Error loading surgeons:", error);
          });
      }

      // Load surgeons when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadSurgeons();
      });
      // Auto-grow function for textareas
      function autoGrow(element) {
        element.style.height = "auto";
        element.style.height = element.scrollHeight + "px";
      }

      // Initialize textareas to be clickable and functional
      function initializeTextareas() {
        const textareas = document.querySelectorAll(
          "textarea.input-overlay, textarea.input-full"
        );
        textareas.forEach((textarea) => {
          // Ensure textarea is clickable
          textarea.style.cursor = "text";
          textarea.style.pointerEvents = "auto";

          // Add click event to focus
          textarea.addEventListener("click", function (e) {
            e.stopPropagation();
            this.focus();
          });

          // Add touch event for mobile
          textarea.addEventListener("touchstart", function (e) {
            e.stopPropagation();
            this.focus();
          });

          // Initialize height
          autoGrow(textarea);
        });
      }

      // Load patient data for editing
      function loadPatientData(patientId) {
        console.log("Loading patient data for ID:", patientId);

        // Test the URL being called
        const url = `get_patient_data_api.php?patient_id=${patientId}`;
        console.log("Calling URL:", url);

        fetch(url)
          .then((response) => {
            console.log("Response status:", response.status);
            console.log("Response headers:", response.headers);
            return response.text(); // Get raw text first
          })
          .then((text) => {
            console.log("Raw response text:", text);
            try {
              const data = JSON.parse(text);
              console.log("Parsed JSON data:", data);
              if (data.success) {
                fillFormWithPatientData(data.data);
              } else {
                console.error("Error loading patient data:", data.message);
              }
            } catch (e) {
              console.error("Failed to parse JSON:", e);
              console.error("Response was:", text);
            }
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      }

      // Fill form with patient data
      function fillFormWithPatientData(patientData) {
        console.log("Filling form with patient data:", patientData);
        const patient = patientData.patient;
        const surgical_details = patientData.surgical_details;
        const surgical_skin_preparation = patientData.surgical_skin_preparation;
        const risk_factors = patientData.risk_factors;
        const implanted_materials = patientData.implanted_materials;
        const drains = patientData.drains;
        const antibiotic_usage = patientData.antibiotic_usage;
        const post_operative_monitoring = patientData.post_operative_monitoring;
        const cultural_dressing = patientData.cultural_dressing;
        const wound_complications = patientData.wound_complications;
        const review_sutures = patientData.review_sutures;
        const review_phone = patientData.review_phone;
        const infection_prevention_notes =
          patientData.infection_prevention_notes;

        // Set patient ID for editing
        setFormValue("patient_id", patient.patient_id);

        // Set basic patient info
        setFormValue("name", patient.name);
        setFormValue("age", patient.age);
        setFormValue("Sex", patient.sex);
        setFormValue("uhid", patient.uhid);
        setFormValue("phone", patient.phone);
        setFormValue("bed", patient.bed_ward);
        setFormValue("address", patient.address);
        setFormValue("diagnosis", patient.primary_diagnosis);
        setFormValue("surgical_procedure", patient.surgical_procedure);
        setFormValue(
          "date_completed",
          formatDateForInput(patient.date_completed)
        );

        // Set surgical details
        if (surgical_details) {
          setFormValue(
            "patient_info[doa]",
            formatDateForInput(surgical_details.doa)
          );
          setFormValue(
            "patient_info[dos]",
            formatDateForInput(surgical_details.dos)
          );
          setFormValue(
            "patient_info[dod]",
            formatDateForInput(surgical_details.dod)
          );

          // Set surgeon with retry logic to handle async dropdown loading
          setSurgeonValue(surgical_details.surgeon);

          setFormValue(
            "operation_duration",
            surgical_details.operation_duration
          );
        }

        // Set surgical skin preparation
        if (surgical_skin_preparation) {
          setRadioValue(
            "surgical_skin_preparation[pre_op_bath]",
            surgical_skin_preparation.pre_op_bath
          );
          setFormValue(
            "pre-notdone",
            surgical_skin_preparation.pre_op_bath_reason
          );
          setRadioValue(
            "surgical_skin_preparation[hair-removal]",
            surgical_skin_preparation.hair_removal
          );
          setFormValue(
            "hair-notdone",
            surgical_skin_preparation.hair_removal_reason
          );
          setRadioValue(
            "surgical_skin_preparation[removal-done]",
            surgical_skin_preparation.hair_removal_location
          );
        }

        // Set risk factors
        if (risk_factors) {
          setFormValue("risk_factor_weight", risk_factors.weight);
          setFormValue("risk_factor_height", risk_factors.height);
          setFormValue("risk_factor_steroids", risk_factors.steroids);
          setFormValue("risk_factor_tuberculosis", risk_factors.tuberculosis);
          setFormValue("risk_factor_others", risk_factors.others);
        }

        // Set implanted materials
        if (implanted_materials) {
          setRadioValue("implanted_used", implanted_materials.implanted_used);
          setFormValue("metal", implanted_materials.metal);
          setFormValue("graft", implanted_materials.graft);
          setFormValue("Patch", implanted_materials.patch);
          setFormValue("Shunt", implanted_materials.shunt_stent);
        }

        // Set drains - dynamically create rows for all drains
        if (drains && drains.length > 0) {
          setRadioValue("drain-used", "Yes");

          // First, add extra rows if needed (beyond the 3 existing rows)
          const maxDrainNumber = Math.max(...drains.map((d) => d.drain_number));
          const existingRows = 3;
          const extraRowsNeeded = Math.max(0, maxDrainNumber - existingRows);

          // Add extra rows
          for (let i = 0; i < extraRowsNeeded; i++) {
            addDrainRow();
          }

          // Now populate all rows with data
          drains.forEach((drain, index) => {
            setFormValue(
              `drain_${drain.drain_number}`,
              drain.drain_description
            );
          });
        } else {
          // If no drains, set to "No"
          setRadioValue("drain-used", "No");
        }

        // Set antibiotic usage - dynamically create rows for all antibiotics
        if (antibiotic_usage && antibiotic_usage.length > 0) {
          // First, add extra rows if needed (beyond the 3 existing rows)
          const maxSerialNo = Math.max(
            ...antibiotic_usage.map((a) => a.serial_no)
          );
          const existingRows = 3;
          const extraRowsNeeded = Math.max(0, maxSerialNo - existingRows);

          // Add extra rows
          for (let i = 0; i < extraRowsNeeded; i++) {
            addAntibioticRow();
          }

          // Now populate all rows with data
          antibiotic_usage.forEach((antibiotic, index) => {
            const i = antibiotic.serial_no;
            setFormValue(`drug-name_${i}`, antibiotic.drug_name);
            setFormValue(`dosage_${i}`, antibiotic.dosage_route_frequency);
            setFormValue(
              `antibiotic_usage[startedon]_${i}`,
              formatDateForInput(antibiotic.started_on)
            );
            setFormValue(
              `antibiotic_usage[stoppeon]_${i}`,
              formatDateForInput(antibiotic.stopped_on)
            );
          });
        }

        // Set post operative monitoring - dynamically create rows for all monitoring entries
        if (post_operative_monitoring && post_operative_monitoring.length > 0) {
          // First, add extra rows if needed (beyond the 3 existing rows)
          const maxDay = Math.max(
            ...post_operative_monitoring.map((m) => m.day)
          );
          const existingRows = 3;
          const extraRowsNeeded = Math.max(0, maxDay - existingRows);

          // Add extra rows
          for (let i = 0; i < extraRowsNeeded; i++) {
            addPostOperativeRow();
          }

          // Now populate all rows with data
          post_operative_monitoring.forEach((monitoring, index) => {
            const i = monitoring.day;
            setFormValue(
              `post-operative[date]_${i}`,
              formatDateForInput(monitoring.monitoring_date)
            );
            setFormValue(`post-dosage_${i}`, monitoring.dosage);
            setFormValue(`type-ofdischarge_${i}`, monitoring.discharge_fluid);
            setFormValue(`tenderness-pain_${i}`, monitoring.tenderness_pain);
            setFormValue(`swelling_${i}`, monitoring.swelling);
            setFormValue(`Fever_${i}`, monitoring.fever);
          });
        }

        // Set cultural dressing
        if (cultural_dressing) {
          setFormValue("Cultural-Swap", cultural_dressing.cultural_swap);
          setFormValue("Dressing-Finding", cultural_dressing.dressing_finding);
        }

        // Set wound complications
        if (wound_complications) {
          setFormValue(
            "Wound-Complication_Date",
            formatDateForInput(wound_complications.complication_date)
          );
          setCheckboxValue(
            "wounddehiscene",
            wound_complications.wound_dehiscence
          );
          setCheckboxValue("AllergicR", wound_complications.allergic_reaction);
          setCheckboxValue(
            "BleedingH",
            wound_complications.bleeding_haemorrhage
          );
          setCheckboxValue("Other", wound_complications.other_complication);
          setFormValue("WoundD-Specify", wound_complications.other_specify);
          setFormValue("WoundD-Notes", wound_complications.notes);

          // Set SSI checkboxes
          setCheckboxValue(
            "SuperficialSSI",
            wound_complications.superficial_ssi
          );
          setCheckboxValue("DeepSI", wound_complications.deep_si);
          setCheckboxValue("OrganSI", wound_complications.organ_space_ssi);

          // Set detailed SSI criteria checkboxes
          setCheckboxValue(
            "wtd1-1",
            wound_complications.purulent_discharge_superficial
          );
          setCheckboxValue(
            "wtd1-2",
            wound_complications.purulent_discharge_deep
          );
          setCheckboxValue(
            "wtd1-3",
            wound_complications.purulent_discharge_organ
          );
          setCheckboxValue(
            "wtd2-1",
            wound_complications.organism_identified_superficial
          );
          setCheckboxValue(
            "wtd2-1b",
            wound_complications.organism_identified_deep
          );
          setCheckboxValue(
            "wtd2-2",
            wound_complications.organism_identified_organ
          );
          setCheckboxValue(
            "wtd3-1",
            wound_complications.clinical_diagnosis_ssi
          );
          setCheckboxValue(
            "wtd3-2",
            wound_complications.deep_incision_reopening
          );
          setCheckboxValue(
            "wtd3-3",
            wound_complications.abscess_evidence_organ
          );
          setCheckboxValue(
            "wtd4-1",
            wound_complications.deliberate_opening_symptoms
          );
          setCheckboxValue("wtd4-2", wound_complications.abscess_evidence_deep);
          setCheckboxValue(
            "wtd4-3",
            wound_complications.not_infected_conditions
          );

          // Set surgeon opinions
          setFormValue(
            "SurgeonOpinion1",
            wound_complications.surgeon_opinion_superficial
          );
          setFormValue(
            "SurgeonOpinion2",
            wound_complications.surgeon_opinion_deep
          );
          setFormValue(
            "SurgeonOpinion3",
            wound_complications.surgeon_opinion_organ
          );
        }

        // Set review sutures
        if (review_sutures) {
          setFormValue(
            "ReviewOn",
            formatDateForInput(review_sutures.review_on)
          );
          setFormValue(
            "SuturesROn",
            formatDateForInput(review_sutures.sutures_removed_on)
          );
        }

        // Set review phone
        if (review_phone) {
          setFormValue(
            "RevieworPhoneDate",
            formatDateForInput(review_phone.review_date)
          );
          setRadioValue("reviewp", review_phone.patient_identification);
          setRadioValue("reviewppain", review_phone.pain);
          setRadioValue("reviewpus", review_phone.pus);
          setRadioValue("reviewbleed", review_phone.bleeding);
          setRadioValue("reviewother", review_phone.other);
        }

        // Set infection prevention notes and signature
        if (infection_prevention_notes) {
          setFormValue(
            "infection_prevention_notes",
            infection_prevention_notes.infection_prevention_notes
          );
          setFormValue("signature", infection_prevention_notes.signature);
        }

        // Initialize textareas after filling data
        initializeTextareas();
      }

      // Helper function to set form values
      function setFormValue(name, value) {
        if (value === null || value === undefined) return;

        const element = document.querySelector(`[name="${name}"]`);
        if (element) {
          element.value = value;
          console.log(`Set ${name} = ${value}`);
          // Trigger autoGrow for textareas
          if (element.tagName === "TEXTAREA") {
            autoGrow(element);
          }
        } else {
          console.log(`Element not found for name: ${name}`);
        }
      }

      // Helper function to set checkbox values
      function setCheckboxValue(name, value) {
        if (value === null || value === undefined) return;

        const checkbox = document.querySelector(
          `input[name="${name}"][type="checkbox"]`
        );
        if (checkbox) {
          checkbox.checked = value === "Yes" || value === 1 || value === true;
          console.log(
            `Set checkbox ${name} = ${value} (checked: ${checkbox.checked})`
          );
        } else {
          console.log(`Checkbox not found for name: ${name}`);
        }
      }

      // Helper function to set radio button values
      function setRadioValue(name, value) {
        if (value === null || value === undefined) return;

        const radio = document.querySelector(
          `input[name="${name}"][value="${value}"]`
        );
        if (radio) {
          radio.checked = true;
          console.log(`Set radio ${name} = ${value} (checked)`);
        } else {
          console.log(
            `Radio button not found for name: ${name}, value: ${value}`
          );
        }
      }

      // Helper function to set surgeon value with retry logic
      function setSurgeonValue(surgeonName) {
        if (!surgeonName) return;

        const surgeonDropdown = document.getElementById("surgeonDropdown");
        if (!surgeonDropdown) {
          console.log("Surgeon dropdown not found, retrying in 100ms...");
          setTimeout(() => setSurgeonValue(surgeonName), 100);
          return;
        }

        // Check if the dropdown has options loaded
        if (surgeonDropdown.options.length <= 1) {
          console.log("Surgeon dropdown not loaded yet, retrying in 200ms...");
          setTimeout(() => setSurgeonValue(surgeonName), 200);
          return;
        }

        // Try to find and select the surgeon
        let found = false;
        for (let i = 0; i < surgeonDropdown.options.length; i++) {
          if (surgeonDropdown.options[i].value === surgeonName) {
            surgeonDropdown.selectedIndex = i;
            found = true;
            console.log(`Set surgeon = ${surgeonName} (found)`);
            break;
          }
        }

        if (!found) {
          console.log(
            `Surgeon "${surgeonName}" not found in dropdown, retrying in 500ms...`
          );
          setTimeout(() => setSurgeonValue(surgeonName), 500);
        }
      }

      // Function to make the form read-only
      function makeFormReadOnly() {
        console.log("Making form read-only...");

        // Disable all input fields
        const inputs = document.querySelectorAll(
          'input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"]'
        );
        inputs.forEach((input) => {
          input.disabled = true;
          input.style.backgroundColor = "#f3f4f6";
          input.style.cursor = "not-allowed";
        });

        // Disable all textareas
        const textareas = document.querySelectorAll("textarea");
        textareas.forEach((textarea) => {
          textarea.disabled = true;
          textarea.style.backgroundColor = "#f3f4f6";
          textarea.style.cursor = "not-allowed";
        });

        // Disable all select dropdowns
        const selects = document.querySelectorAll("select");
        selects.forEach((select) => {
          select.disabled = true;
          select.style.backgroundColor = "#f3f4f6";
          select.style.cursor = "not-allowed";
        });

        // Disable all checkboxes but keep selected ones visible
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((checkbox) => {
          checkbox.disabled = true;
          checkbox.style.cursor = "not-allowed";
          // If checkbox is checked, make it more visible with black styling
          if (checkbox.checked) {
            checkbox.style.accentColor = "#000000";
            checkbox.style.transform = "scale(1.2)";
            checkbox.style.filter = "brightness(0) saturate(100%)";
          }
        });

        // Disable all radio buttons but keep selected ones visible
        const radios = document.querySelectorAll('input[type="radio"]');
        radios.forEach((radio) => {
          radio.disabled = true;
          radio.style.cursor = "not-allowed";
          // If radio is checked, make it more visible with black styling
          if (radio.checked) {
            radio.style.accentColor = "#000000";
            radio.style.transform = "scale(1.2)";
            radio.style.filter = "brightness(0) saturate(100%)";
          }
        });

        // Hide all submit buttons and action buttons
        const submitButtons = document.querySelectorAll(
          'button[type="submit"], input[type="submit"]'
        );
        submitButtons.forEach((button) => {
          button.style.display = "none";
        });

        // Hide add/remove row buttons
        const actionButtons = document.querySelectorAll(
          'button[onclick*="add"], button[onclick*="remove"]'
        );
        actionButtons.forEach((button) => {
          button.style.display = "none";
        });

        // Add a read-only indicator
        const header = document.querySelector("h1");
        if (header) {
          header.innerHTML +=
            ' <span class="readonly-indicator" style="color: #dc2626;">(Read-Only View)</span>';
        }

        // Change page title
        document.title = "Patient Details - Read Only";

        // Add CSS for better visibility of selected radio buttons and checkboxes
        const style = document.createElement("style");
        style.textContent = `
          /* Enhanced styling for selected radio buttons and checkboxes in read-only mode */
          input[type="radio"]:checked {
            accent-color: #000000 !important;
            transform: scale(1.3) !important;
            filter: brightness(0) saturate(100%) !important;
          }
          
          input[type="checkbox"]:checked {
            accent-color: #000000 !important;
            transform: scale(1.3) !important;
            filter: brightness(0) saturate(100%) !important;
          }
          
          /* Make labels for selected elements more prominent */
          input[type="radio"]:checked + label,
          input[type="checkbox"]:checked + label {
            font-weight: bold !important;
            color: #000000 !important;
          }
          
          /* Consistent font sizes for mobile and PC */
          * {
            font-size: 14px !important;
          }
          
          /* Headers and titles */
          h1, h2, h3, h4, h5, h6 {
            font-size: 16px !important;
            font-weight: bold !important;
          }
          
          /* Form labels */
          label {
            font-size: 14px !important;
          }
          
          /* Input fields and textareas */
          input, textarea, select {
            font-size: 14px !important;
          }
          
          /* Table content */
          table, th, td {
            font-size: 14px !important;
          }
          
          /* Buttons */
          button {
            font-size: 14px !important;
          }
          
          /* Read-only indicator */
          .readonly-indicator {
            font-size: 12px !important;
          }
        `;
        document.head.appendChild(style);

        console.log("Form is now read-only");
      }

      // Helper function to delete row from database
      function deleteRowFromDatabase(
        patientId,
        tableType,
        rowNumber,
        onSuccess
      ) {
        const formData = new FormData();
        formData.append("patient_id", patientId);
        formData.append("table_type", tableType);
        formData.append("row_number", rowNumber);

        fetch("delete_row.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(
                `Successfully deleted row ${rowNumber} from ${tableType} table`
              );
              if (onSuccess) onSuccess();
            } else {
              console.error("Failed to delete row:", data.message);
              alert("Failed to delete row: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error deleting row:", error);
            alert("Error deleting row. Please try again.");
          });
      }

      // Helper function to format date for input fields
      function formatDateForInput(dateString) {
        if (!dateString) return "";

        // Convert from YYYY-MM-DD to DD/MM/YYYY for display
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "";

        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();

        return `${day}/${month}/${year}`;
      }

      // UHID validation function
      function checkUHIDAvailability(uhid) {
        if (!uhid.trim()) return;

        const formData = new FormData();
        formData.append("uhid", uhid);

        fetch("check_uhid.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            const uhidInput = document.querySelector('input[name="uhid"]');
            const uhidFeedback = document.getElementById("uhidFeedback");

            if (data.success) {
              if (data.available) {
                uhidInput.style.borderColor = "#28a745";
                uhidFeedback.style.display = "none";
              } else {
                uhidInput.style.borderColor = "#dc3545";
                uhidFeedback.textContent =
                  "✗ UHID already exists. Please use a unique UHID.";
                uhidFeedback.style.color = "#dc3545";
                uhidFeedback.style.display = "block";
              }
            }
          })
          .catch((error) => {
            console.error("Error checking UHID:", error);
          });
      }

      // Form submission handler
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize textareas
        initializeTextareas();

        // Initialize datepickers for existing date fields
        if (typeof $.fn.datepicker !== "undefined") {
          $(".datepicker").datepicker({
            dateFormat: "dd/mm/yy",
            changeMonth: true,
            changeYear: true,
          });
        }

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get("patient_id");
        const isReadOnly = urlParams.get("readonly") === "true";

        if (patientId) {
          // Load patient data for editing
          loadPatientData(patientId);

          // If in read-only mode, disable all form inputs
          if (isReadOnly) {
            makeFormReadOnly();
          }
        } else if (isReadOnly) {
          // If read-only mode but no patient ID, show error
          alert("No patient ID provided for read-only view.");
          window.close();
        }

        // Add UHID validation
        const uhidInput = document.querySelector('input[name="uhid"]');
        if (uhidInput) {
          let uhidTimeout;
          uhidInput.addEventListener("input", function () {
            clearTimeout(uhidTimeout);
            const uhid = this.value;

            // Clear previous feedback
            const uhidFeedback = document.getElementById("uhidFeedback");
            if (uhidFeedback) {
              uhidFeedback.style.display = "none";
            }

            // Reset border color
            this.style.borderColor = "";

            // Check UHID after 500ms delay
            uhidTimeout = setTimeout(() => {
              checkUHIDAvailability(uhid);
            }, 500);
          });
        }

        const form = document.querySelector("form");

        if (form) {
          form.addEventListener("submit", async function (e) {
            e.preventDefault();

            // Check session status before allowing form submission
            try {
              const response = await fetch("check_nurse_session.php");
              const data = await response.json();

              if (!data.success || !data.logged_in) {
                // User is not logged in, show popup and prevent submission
                showLoginPopup();
                return false;
              }

              // User is logged in, proceed with form submission
              console.log("Session valid, proceeding with form submission");
            } catch (error) {
              console.error("Session check failed:", error);
              showLoginPopup(
                "Unable to verify your login status. Please try logging in again."
              );
              return false;
            }

            // Get form data
            const formData = new FormData(form);
            const name = formData.get("name") || "";
            const uhid = formData.get("uhid") || "";

            // Validate required fields
            if (!name.trim() || !uhid.trim()) {
              // Show validation alert
              const validationAlert =
                document.getElementById("validationAlert");
              validationAlert.style.display = "block";

              // Hide validation alert after 3 seconds
              setTimeout(() => {
                validationAlert.style.display = "none";
              }, 3000);

              return; // Stop form submission
            }

            // Show loading message
            const messageBox = document.getElementById("messageBox");
            messageBox.style.display = "block";
            messageBox.innerHTML = `<div style="background-color: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0;">Saving data, please wait...</div>`;

            // Determine if this is an update or new submission
            const patientId = formData.get("patient_id");
            const isUpdate = patientId && patientId.trim() !== "";

            // Send data to server
            fetch("submit_form_working.php", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  // Hide the message box
                  messageBox.style.display = "none";

                  // Show success alert
                  const successAlert = document.getElementById("successAlert");
                  successAlert.style.display = "block";
                  const message = isUpdate
                    ? "Patient data updated successfully!"
                    : "Patient data saved successfully!";
                  successAlert.innerHTML = `<div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"><i class="fas fa-check-circle" style="margin-right: 8px; font-size: 18px"></i><span style="font-weight: bold; font-size: 16px">${message}</span></div>`;

                  // Clear form only for new submissions
                  if (!isUpdate) {
                    form.reset();
                  }

                  // Redirect after 2 seconds
                  setTimeout(() => {
                    window.location.href = "index.html";
                  }, 2000);
                } else {
                  // Check if it's a UHID duplicate error
                  if (
                    data.message &&
                    data.message.includes("UHID already exists")
                  ) {
                    const uhidInput =
                      document.querySelector('input[name="uhid"]');
                    const uhidFeedback =
                      document.getElementById("uhidFeedback");

                    uhidInput.style.borderColor = "#dc3545";
                    uhidFeedback.textContent = "✗ UHID already exists";
                    uhidFeedback.style.color = "#dc3545";
                    uhidFeedback.style.display = "block";
                  }

                  messageBox.innerHTML =
                    '<div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;">Error: ' +
                    data.message +
                    "</div>";
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                messageBox.innerHTML =
                  '<div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;">Network error occurred. Please try again.</div>';
              });
          });
        }

        // Dynamic row addition functions
        function addDrainRow() {
          const tbody = document.querySelector("#drain-table tbody");
          const rows = tbody.querySelectorAll(".drain-row");
          const newRowNumber = rows.length + 1;

          const newRow = document.createElement("tr");
          newRow.className = "drain-row";
          newRow.innerHTML = `
            <td class="tg-k2l0">${newRowNumber}</td>
            <td class="tg-1wig">
              <textarea
                name="drain_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="min-height: 28px; line-height: 1.2"
              ></textarea>
            </td>
          `;

          tbody.appendChild(newRow);
          initializeTextareas();
        }

        function removeDrainRow() {
          const tbody = document.querySelector("#drain-table tbody");
          const rows = tbody.querySelectorAll(".drain-row");

          if (rows.length > 1) {
            const rowToRemove = rows[rows.length - 1];
            const rowNumber = rows.length; // The row number being removed

            // Get patient ID from the form
            const patientId = document.querySelector(
              'input[name="patient_id"]'
            )?.value;

            if (patientId) {
              // Delete from database first
              deleteRowFromDatabase(patientId, "drains", rowNumber, () => {
                // After successful deletion, remove from DOM
                tbody.removeChild(rowToRemove);
                // Renumber the remaining rows
                const remainingRows = tbody.querySelectorAll(".drain-row");
                remainingRows.forEach((row, index) => {
                  const numberCell = row.querySelector("td:first-child");
                  numberCell.textContent = index + 1;
                });
              });
            } else {
              // If no patient ID (new form), just remove from DOM
              tbody.removeChild(rowToRemove);
              // Renumber the remaining rows
              const remainingRows = tbody.querySelectorAll(".drain-row");
              remainingRows.forEach((row, index) => {
                const numberCell = row.querySelector("td:first-child");
                numberCell.textContent = index + 1;
              });
            }
          }
        }

        function addAntibioticRow() {
          const tbody = document.querySelector("#antibiotic-table tbody");
          const rows = tbody.querySelectorAll(".antibiotic-row");
          const newRowNumber = rows.length + 1;

          const newRow = document.createElement("tr");
          newRow.className = "antibiotic-row";
          newRow.innerHTML = `
            <td class="tg-k2l0">${newRowNumber}</td>
            <td class="tg-1wig">
              <textarea
                name="drug-name_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="min-height: 28px; line-height: 1.2"
              ></textarea>
            </td>
            <td class="tg-1wig">
              <textarea
                name="dosage_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="min-height: 28px; line-height: 1.2"
              ></textarea>
            </td>
            <td class="tg-1wig">
              <input
                type="text"
                name="antibiotic_usage[startedon]_${newRowNumber}"
                class="datepicker"
                placeholder="dd/mm/yyyy"
                style="width: 100px"
                value=""
              />
            </td>
            <td class="tg-1wig">
              <input
                type="text"
                name="antibiotic_usage[stoppeon]_${newRowNumber}"
                class="datepicker"
                placeholder="dd/mm/yyyy"
                style="width: 100px"
                value=""
              />
            </td>
          `;

          tbody.appendChild(newRow);
          initializeTextareas();
          // Reinitialize datepickers for new inputs
          if (typeof $.fn.datepicker !== "undefined") {
            $(newRow).find(".datepicker").datepicker({
              dateFormat: "dd/mm/yy",
              changeMonth: true,
              changeYear: true,
            });
          }
        }

        function removeAntibioticRow() {
          const tbody = document.querySelector("#antibiotic-table tbody");
          const rows = tbody.querySelectorAll(".antibiotic-row");

          if (rows.length > 1) {
            const rowToRemove = rows[rows.length - 1];
            const rowNumber = rows.length; // The row number being removed

            // Get patient ID from the form
            const patientId = document.querySelector(
              'input[name="patient_id"]'
            )?.value;

            if (patientId) {
              // Delete from database first
              deleteRowFromDatabase(patientId, "antibiotics", rowNumber, () => {
                // After successful deletion, remove from DOM
                tbody.removeChild(rowToRemove);
                // Renumber the remaining rows
                const remainingRows = tbody.querySelectorAll(".antibiotic-row");
                remainingRows.forEach((row, index) => {
                  const numberCell = row.querySelector("td:first-child");
                  numberCell.textContent = index + 1;
                });
              });
            } else {
              // If no patient ID (new form), just remove from DOM
              tbody.removeChild(rowToRemove);
              // Renumber the remaining rows
              const remainingRows = tbody.querySelectorAll(".antibiotic-row");
              remainingRows.forEach((row, index) => {
                const numberCell = row.querySelector("td:first-child");
                numberCell.textContent = index + 1;
              });
            }
          }
        }

        function addPostOperativeRow() {
          const tbody = document.querySelector("#post-operative-table tbody");
          const rows = tbody.querySelectorAll(".post-operative-row");
          const newRowNumber = rows.length + 1;

          const newRow = document.createElement("tr");
          newRow.className = "post-operative-row";
          newRow.innerHTML = `
            <td class="tg-k2l0">${newRowNumber}</td>
            <td class="tg-0lax">
              <input
                type="text"
                name="post-operative[date]_${newRowNumber}"
                class="datepicker"
                placeholder="dd/mm/yyyy"
                style="width: 100px; font-size: 13px !important; font-weight: bold !important; color: #000;"
                value=""
              />
            </td>
            <td class="tg-0lax">
              <textarea
                name="post-dosage_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="
                  min-height: 28px;
                  line-height: 1.2;
                  text-align: center;
                  font-size: 13px !important;
                  font-weight: bold !important;
                  color: #000;
                "
              ></textarea>
            </td>
            <td class="tg-0lax">
              <textarea
                name="type-ofdischarge_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="
                  min-height: 28px;
                  line-height: 1.2;
                  text-align: center;
                  font-size: 13px !important;
                  font-weight: bold !important;
                "
              ></textarea>
            </td>
            <td class="tg-0lax">
              <textarea
                name="tenderness-pain_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="
                  min-height: 28px;
                  line-height: 1.2;
                  text-align: center;
                  font-size: 13px !important;
                  font-weight: bold !important;
                "
              ></textarea>
            </td>
            <td class="tg-0lax">
              <textarea
                name="swelling_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="
                  min-height: 28px;
                  line-height: 1.2;
                  text-align: center;
                  font-size: 13px !important;
                  font-weight: bold !important;
                "
              ></textarea>
            </td>
            <td class="tg-0lax">
              <textarea
                name="fever_${newRowNumber}"
                class="input-overlay input-full"
                rows="1"
                oninput="autoGrow(this)"
                style="
                  min-height: 28px;
                  line-height: 1.2;
                  text-align: center;
                  font-size: 13px !important;
                  font-weight: bold !important;
                "
              ></textarea>
            </td>
          `;

          tbody.appendChild(newRow);
          initializeTextareas();
          // Reinitialize datepickers for new inputs
          if (typeof $.fn.datepicker !== "undefined") {
            $(newRow).find(".datepicker").datepicker({
              dateFormat: "dd/mm/yy",
              changeMonth: true,
              changeYear: true,
            });
          }
        }

        function removePostOperativeRow() {
          const tbody = document.querySelector("#post-operative-table tbody");
          const rows = tbody.querySelectorAll(".post-operative-row");

          if (rows.length > 1) {
            const rowToRemove = rows[rows.length - 1];
            const rowNumber = rows.length; // The row number being removed

            // Get patient ID from the form
            const patientId = document.querySelector(
              'input[name="patient_id"]'
            )?.value;

            if (patientId) {
              // Delete from database first
              deleteRowFromDatabase(
                patientId,
                "post_operative",
                rowNumber,
                () => {
                  // After successful deletion, remove from DOM
                  tbody.removeChild(rowToRemove);
                  // Renumber the remaining rows
                  const remainingRows = tbody.querySelectorAll(
                    ".post-operative-row"
                  );
                  remainingRows.forEach((row, index) => {
                    const numberCell = row.querySelector("td:first-child");
                    numberCell.textContent = index + 1;
                  });
                }
              );
            } else {
              // If no patient ID (new form), just remove from DOM
              tbody.removeChild(rowToRemove);
              // Renumber the remaining rows
              const remainingRows = tbody.querySelectorAll(
                ".post-operative-row"
              );
              remainingRows.forEach((row, index) => {
                const numberCell = row.querySelector("td:first-child");
                numberCell.textContent = index + 1;
              });
            }
          }
        }

        // Session management for form page
        let sessionCheckInterval;
        let sessionTimeout;
        const SESSION_TIMEOUT_MINUTES = 30;
        const SESSION_CHECK_INTERVAL = 60000; // Check every minute

        // Function to check session status
        async function checkSessionStatus() {
          try {
            const response = await fetch("check_nurse_session.php");
            const data = await response.json();

            if (!data.success || !data.logged_in) {
              // Session expired, redirect to login
              clearSessionTimers();
              alert("Your session has expired. Please log in again.");
              window.location.href = "login.html?msg=session_expired";
              return false;
            }

            // Update session activity
            updateSessionActivity();
            return true;
          } catch (error) {
            console.error("Session check failed:", error);
            return false;
          }
        }

        // Function to update session activity
        async function updateSessionActivity() {
          try {
            await fetch("update_session_activity.php");
          } catch (error) {
            console.error("Failed to update session activity:", error);
          }
        }

        // Function to start session timers
        function startSessionTimers() {
          // Check session every minute
          sessionCheckInterval = setInterval(
            checkSessionStatus,
            SESSION_CHECK_INTERVAL
          );

          // Set timeout for 30 minutes
          sessionTimeout = setTimeout(() => {
            clearSessionTimers();
            alert(
              "Your session has expired due to inactivity. Please log in again."
            );
            window.location.href = "login.html?msg=session_expired";
          }, SESSION_TIMEOUT_MINUTES * 60 * 1000);
        }

        // Function to clear session timers
        function clearSessionTimers() {
          if (sessionCheckInterval) {
            clearInterval(sessionCheckInterval);
          }
          if (sessionTimeout) {
            clearTimeout(sessionTimeout);
          }
        }

        // Function to reset session timeout on user activity
        function resetSessionTimeout() {
          clearSessionTimers();
          startSessionTimers();
        }

        // Login popup functionality - Global functions
        function showLoginPopup(
          message = "Please login to submit the form. You will be redirected to the login page."
        ) {
          // Create popup HTML
          const popupHTML = `
            <div id="loginPopup" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0, 0, 0, 0.5);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 10000;
              font-family: Arial, sans-serif;
            ">
              <div style="
                background-color: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
                text-align: center;
                position: relative;
              ">
                <div style="
                  font-size: 24px;
                  color: #e74c3c;
                  margin-bottom: 20px;
                ">
                  ⚠️ Login Required
                </div>
                <div style="
                  font-size: 16px;
                  color: #333;
                  margin-bottom: 25px;
                  line-height: 1.5;
                ">
                  ${message}
                </div>
                <div style="
                  display: flex;
                  gap: 15px;
                  justify-content: center;
                ">
                  <button onclick="closeLoginPopup()" style="
                    background-color: #95a5a6;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                  ">
                    Cancel
                  </button>
                  <button onclick="redirectToLogin()" style="
                    background-color: #3498db;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                  ">
                    Go to Login
                  </button>
                </div>
              </div>
            </div>
          `;

          // Add popup to body
          document.body.insertAdjacentHTML("beforeend", popupHTML);

          // Add escape key listener
          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
              closeLoginPopup();
            }
          });
        }

        function closeLoginPopup() {
          const popup = document.getElementById("loginPopup");
          if (popup) {
            popup.remove();
          }
        }

        function redirectToLogin() {
          closeLoginPopup();
          window.location.href = "login.html";
        }

        // Make functions globally accessible
        window.closeLoginPopup = closeLoginPopup;
        window.redirectToLogin = redirectToLogin;
        window.showLoginPopup = showLoginPopup;

        // Initialize session management when page loads
        document.addEventListener("DOMContentLoaded", function () {
          // Check session status first
          checkSessionStatus().then((sessionValid) => {
            if (sessionValid) {
              // Start session timers
              startSessionTimers();

              // Add activity listeners to reset timeout
              const activityEvents = [
                "mousedown",
                "mousemove",
                "keypress",
                "scroll",
                "touchstart",
                "click",
              ];
              activityEvents.forEach((event) => {
                document.addEventListener(event, resetSessionTimeout, true);
              });
            }
          });
        });
      });
    </script>
  </body>
</html>
